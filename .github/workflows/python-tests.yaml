name: Python Tests

on:
  push:
    branches:
      - '*'
      - '!main'

jobs:
  test:
    runs-on: windows-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v2

      - name: Setup py installation
        uses: actions/setup-python@v2
        with: 
          python-version: 3.x

      - name: Install dependancies
        run: pip install PyQt5 opencv-python numpy pillow scipy matplotlib pytest

      - name: Run tests
        run: pytest -s test/test_ecosystem.py

      - name: Create Pull Request
        run: |
          TOKEN=$GITHUB_TOKEN
          BASE=main
          HEAD=${{ github.ref }}
          TITLE="Automated PR from $HEAD to $BASE"
          BODY="This PR was created automatically after successful tests."
          RESPONSE=$(curl -X POST \
            -H "Authorization: token $TOKEN" \
            -d '{
              "title": "'"$TITLE"'",
              "base": "'"$BASE"'",
              "head": "'"$HEAD"'",
              "body": "'"$BODY"'"
            }' \
            "https://api.github.com/repos/$GITHUB_REPOSITORY/pulls")
          PR_URL=$(echo $RESPONSE | jq -r .html_url)
          echo "Created Pull Request: $PR_URL"
        if: success()
      - name: Merge Pull Request
        run: |
          TOKEN=$GITHUB_TOKEN
          PR_NUMBER=$(curl -H "Authorization: token $TOKEN" \
            "https://api.github.com/repos/$GITHUB_REPOSITORY/pulls?head=$GITHUB_ACTOR:$GITHUB_REF" | jq -r .[0].number)
          if [ -z "$PR_NUMBER" ]; then
            echo "Pull Request not found."
            exit 1
          fi
          curl -X PUT -H "Authorization: token $TOKEN" \
            "https://api.github.com/repos/$GITHUB_REPOSITORY/pulls/$PR_NUMBER/merge"
        if: success()
